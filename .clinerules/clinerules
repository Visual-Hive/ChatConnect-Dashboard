# Chat Connect Dashboard - Project Rules

## Project Overview

You are developing Chat Connect Dashboard, a multi-tenant SaaS platform that provides embeddable chat widgets powered by AI/LLM with knowledge base integration. This is a full-stack web application built with React, Express, PostgreSQL, and a Python AI backend using FastAPI and LangGraph.

## ðŸš¨ CRITICAL: Read Documentation First

**BEFORE writing ANY code, you MUST:**
- Check `docs/IMPLEMENTATION_AUDIT.md` for current system state
- Review `docs/ARCHITECTURE.md` for system design
- Consult `docs/DEVELOPMENT.md` for conventions and patterns
- Check `docs/MULTI_TENANT_SCHEMA_PLAN.md` for data isolation strategy
- Review `docs/BILLING_AND_LIMITS.md` for usage limits and billing rules

## Security

### Sensitive Files
DO NOT read or modify:
- `.env` files
- Any file containing API keys, tokens, or credentials
- Database connection strings
- JWT secrets
- OAuth client secrets

### Critical Security Rules
- **Multi-tenant isolation is MANDATORY** - every query must filter by clientId
- **API key authentication required** for all widget endpoints
- **Domain restriction validation** must be enforced on all widget requests
- **Rate limiting** must be implemented (see BILLING_AND_LIMITS.md)
- **Input validation** and sanitization on all user inputs
- **SQL injection prevention** using parameterized queries only
- **XSS prevention** - sanitize all user-generated content

### Security Patterns
```typescript
// âœ… ALWAYS filter by clientId
const widget = await db.query.widgetConfig.findFirst({
  where: and(
    eq(widgetConfig.clientId, clientId),
    eq(widgetConfig.id, widgetId)
  )
});

// âŒ NEVER query without clientId filter
const widget = await db.query.widgetConfig.findFirst({
  where: eq(widgetConfig.id, widgetId) // DANGEROUS!
});
```

## Architecture

### Core Principles
1. **Multi-tenant by design** - Complete data isolation per client
2. **Widget-first API** - Optimized for embedded widget performance
3. **Knowledge base integration** - PostgreSQL + Qdrant for document storage and search
4. **Python AI backend** - FastAPI + LangGraph for LLM processing
5. **Dashboard for configuration** - Client self-service
6. **Tiered pricing** - Free (testing only) and Paid (production deployment)

### System Components
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CLIENT WEBSITES                                    â”‚
â”‚                      (Paid tier only - production)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Embeds widget.js (paid tier)
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           WIDGET LAYER                                       â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                     widget.js (Vanilla JS)                        â”‚      â”‚
â”‚   â”‚                                                                   â”‚      â”‚
â”‚   â”‚  â€¢ Loads config from Express API                                 â”‚      â”‚
â”‚   â”‚  â€¢ Sends chat messages to Python Backend (FastAPI)               â”‚      â”‚
â”‚   â”‚  â€¢ Streams responses via SSE                                     â”‚      â”‚
â”‚   â”‚  â€¢ Local session management                                      â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                              â”‚
          â”‚ GET /api/widget/config                       â”‚ POST /chat (streaming)
          â–¼                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     EXPRESS API             â”‚          â”‚         PYTHON BACKEND              â”‚
â”‚     (Dashboard + Config)    â”‚          â”‚         (AI Processing)             â”‚
â”‚                             â”‚          â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Dashboard Routes    â”‚  â”‚          â”‚  â”‚        FastAPI              â”‚   â”‚
â”‚  â”‚   â€¢ Auth              â”‚  â”‚          â”‚  â”‚   â€¢ POST /chat              â”‚   â”‚
â”‚  â”‚   â€¢ Widget config     â”‚  â”‚          â”‚  â”‚   â€¢ POST /chat/stream       â”‚   â”‚
â”‚  â”‚   â€¢ Client management â”‚  â”‚          â”‚  â”‚   â€¢ POST /process-document  â”‚   â”‚
â”‚  â”‚   â€¢ Document upload   â”‚  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚   â€¢ GET /health             â”‚   â”‚
â”‚  â”‚   â€¢ Usage & billing   â”‚  â”‚  Internalâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   API    â”‚                â”‚                    â”‚
â”‚                             â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”‚       LangGraph             â”‚   â”‚
â”‚  â”‚   Widget Routes       â”‚  â”‚          â”‚  â”‚   â€¢ retrieve node           â”‚   â”‚
â”‚  â”‚   â€¢ GET /config       â”‚  â”‚          â”‚  â”‚   â€¢ generate node           â”‚   â”‚
â”‚  â”‚   â€¢ Health check      â”‚  â”‚          â”‚  â”‚   â€¢ log node (async)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚          â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                            â”‚
               â–¼                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATA LAYER                                         â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   PostgreSQL    â”‚  â”‚     Qdrant      â”‚  â”‚     Redis       â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚  â€¢ users        â”‚  â”‚  â€¢ embeddings   â”‚  â”‚  â€¢ query cache  â”‚              â”‚
â”‚  â”‚  â€¢ clients      â”‚  â”‚  â€¢ chunks       â”‚  â”‚  â€¢ embed cache  â”‚              â”‚
â”‚  â”‚  â€¢ widgets      â”‚  â”‚  â€¢ metadata     â”‚  â”‚  â€¢ rate limits  â”‚              â”‚
â”‚  â”‚  â€¢ documents    â”‚  â”‚                 â”‚  â”‚  â€¢ sessions     â”‚              â”‚
â”‚  â”‚  â€¢ chat_logs    â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚  â€¢ usage_stats  â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚  â€¢ billing      â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technology Stack
- **Frontend:** React 18, TypeScript, Tailwind CSS, Vite
- **Dashboard API:** Express.js, Node.js 20+, Drizzle ORM
- **AI Backend:** Python 3.11+, FastAPI, LangGraph, Uvicorn
- **Database:** PostgreSQL 16+
- **Vector Store:** Qdrant
- **Cache:** Redis 7+
- **LLM Providers:** 
  - Free tier: OpenAI GPT-4o-mini
  - Paid tier: Anthropic Claude Sonnet 4.5
- **Embeddings:** OpenAI text-embedding-3-large
- **Deployment:** Docker, Docker Compose

### Data Flow Patterns

**Widget Chat Flow:**
```
1. User types message in widget
2. Widget POSTs to Python backend /api/widget/chat/stream (with API key)
3. Python backend validates API key + checks rate limits
4. Python backend checks deployment restrictions (free = dashboard only)
5. LangGraph workflow executes:
   a. Retrieve: Query Qdrant for relevant context (filtered by clientId)
   b. Generate: Call LLM (GPT-4o-mini or Claude based on tier)
   c. Log: Async save to PostgreSQL (chat_logs, usage_stats)
6. SSE stream response back to widget
7. Widget displays response with typing effect
```

**Configuration Flow:**
```
1. User logs into dashboard
2. Edits widget settings (appearance, prompts, domains)
3. Dashboard PUTs to /api/dashboard/widget/:clientId
4. Backend validates and saves to PostgreSQL
5. Next widget load reflects new config
```

**Document Upload Flow:**
```
1. User uploads file in dashboard (PDF, DOCX, TXT, CSV)
2. Express validates file type/size, saves metadata to PostgreSQL
3. Express forwards to Python backend /process-document
4. Python parses â†’ chunks â†’ embeds â†’ stores in Qdrant
5. Progress updates via polling or WebSocket
6. Document available for RAG queries
```

## Billing & Rate Limiting

### Tier Overview

| Feature | Free Tier | Paid Tier |
|---------|-----------|-----------|
| Dashboard access | âœ… | âœ… |
| Widget testing (dashboard) | âœ… 100 req/hour | âœ… Unlimited |
| External deployment | âŒ | âœ… |
| Rate limit | 100 req/hour | 1000 req/hour base |
| Overage | N/A | Pay per request |
| LLM Model | GPT-4o-mini | Claude Sonnet 4.5 |
| Email alerts | âŒ | âœ… (80% usage) |
| Hard cap option | N/A | âœ… (widget hides) |

### Implementation Rules

**Free Tier:**
- Widget ONLY works on dashboard preview/test page
- Origin must match dashboard domain
- 100 requests/hour (silent limit, no error shown)
- After limit: Show friendly "Please upgrade" message
- Cannot copy embed code for external use

**Paid Tier:**
- Widget works on any allowed domain
- 1000 requests/hour included in base plan
- Email alert at 80% usage
- Options when limit reached:
  - Pay overage (default)
  - Hard cap (widget disappears)
- Overage rate: $X per 100 requests (TBD)

### Rate Limit Implementation
```python
# Redis key pattern: rate:{client_id}:{hour_bucket}
# Use INCR with EXPIRE for atomic counting

async def check_rate_limit(client_id: str, tier: str) -> bool:
    limit = 100 if tier == "free" else client.hourly_limit
    current = await redis.incr(f"rate:{client_id}:{hour_bucket}")
    
    if current == 1:
        await redis.expire(key, 3600)  # 1 hour TTL
    
    if current > limit:
        if tier == "paid" and not client.hard_cap_enabled:
            # Allow but flag for overage billing
            await record_overage(client_id)
            return True
        return False
    
    return True
```

## Code Style

### TypeScript Standards
- **Strict mode enabled** - No `any` types, use `unknown` when uncertain
- **Explicit return types** for all functions
- **Interface over type** for object shapes
- **Type guards** for runtime type checking

```typescript
// âœ… GOOD
interface WidgetConfig {
  clientId: string;
  apiKey: string;
  appearance: {
    primaryColor: string;
    position: 'bottom-right' | 'bottom-left';
  };
}

function updateConfig(config: WidgetConfig): Promise<WidgetConfig> {
  // implementation
}

// âŒ BAD
function updateConfig(config: any) {  // No 'any'!
  // implementation
}
```

### Python Standards
- **Type hints required** - All functions must have type annotations
- **Pydantic for validation** - Use models for all request/response data
- **Async by default** - Use async/await for I/O operations
- **Structured logging** - Use structlog, not print()

```python
# âœ… GOOD
async def get_client_config(client_id: str) -> ClientConfig | None:
    """Retrieve client configuration by ID."""
    result = await db.fetch_one(
        "SELECT * FROM clients WHERE id = $1",
        client_id
    )
    return ClientConfig(**result) if result else None

# âŒ BAD
def get_client_config(client_id):  # Missing types!
    print(f"Getting config for {client_id}")  # Use logger!
    # ...
```

### React Patterns
- **Functional components only** - No class components
- **Hooks for state** - useState, useEffect, custom hooks
- **Component composition** - Small, focused components
- **Props validation** - TypeScript interfaces for all props

### API Development
- **RESTful conventions** - Proper HTTP methods and status codes
- **Consistent response format:**
```typescript
// Success
{ success: true, data: T }

// Error
{ success: false, error: { code: string, message: string } }
```

### Database Patterns
- **Drizzle ORM (Express)** - Type-safe queries
- **asyncpg (Python)** - Async PostgreSQL access
- **Migration-based schema** - Never modify schema directly in prod
- **Soft deletes** - Use `deletedAt` timestamp, don't actually delete
- **Timestamps** - All tables have `createdAt` and `updatedAt`

```typescript
// âœ… GOOD - Multi-tenant safe query
const widgets = await db.query.widgetConfig.findMany({
  where: eq(widgetConfig.clientId, clientId)
});

// âœ… GOOD - Soft delete
await db.update(widgetConfig)
  .set({ deletedAt: new Date() })
  .where(eq(widgetConfig.id, id));

// âŒ BAD - Hard delete
await db.delete(widgetConfig).where(eq(widgetConfig.id, id));
```

### Naming Conventions
```typescript
// Components: PascalCase
export function WidgetConfigPanel() {}

// Functions: camelCase
function validateApiKey() {}

// Constants: UPPER_SNAKE_CASE
const MAX_FILE_SIZE = 5_000_000;
const API_BASE_URL = '/api';

// Database tables: snake_case
const widget_config = pgTable('widget_config', { ... });

// API routes: kebab-case
router.get('/widget-config', handler);

// Files:
// - Components: PascalCase (WidgetConfig.tsx)
// - Utilities: camelCase (apiClient.ts)
// - Types: camelCase (widgetTypes.ts)
// - Python: snake_case (widget_routes.py)
```

## Testing

### Test Requirements
- **Unit tests** - Core business logic (validation, formatting, calculations)
- **Integration tests** - API endpoints with database
- **E2E tests** - Critical user flows (widget embedding, chat, config)
- **Multi-tenant isolation tests** - CRITICAL

### Testing Patterns
```typescript
describe('Widget API', () => {
  it('should validate API key before processing request', async () => {
    const response = await request(app)
      .post('/api/widget/chat')
      .send({ message: 'Hello' })
      .expect(401);
    
    expect(response.body.error.code).toBe('INVALID_API_KEY');
  });

  it('should enforce multi-tenant isolation', async () => {
    const client1Widget = await createTestWidget({ clientId: 'client1' });
    const client2Token = generateToken({ clientId: 'client2' });
    
    const response = await request(app)
      .get(`/api/dashboard/widget/${client1Widget.id}`)
      .set('Authorization', `Bearer ${client2Token}`)
      .expect(404); // Should not find client1's widget
  });
  
  it('should block free tier from external deployment', async () => {
    const freeClient = await createTestClient({ tier: 'free' });
    
    const response = await request(pythonApp)
      .post('/api/widget/chat')
      .set('x-api-key', freeClient.apiKey)
      .set('Origin', 'https://external-site.com')  // Not dashboard
      .send({ message: 'Hello', sessionId: uuid() })
      .expect(403);
    
    expect(response.body.error.code).toBe('DEPLOYMENT_NOT_ALLOWED');
  });
});
```

## Documentation

### Update When Changing
- `docs/ARCHITECTURE.md` - System design changes
- `docs/DEVELOPMENT.md` - New patterns or conventions
- `docs/IMPLEMENTATION_AUDIT.md` - Track what's been built
- `docs/API.md` - API endpoint changes
- `docs/BILLING_AND_LIMITS.md` - Pricing or limit changes
- `README.md` - User-facing changes

### Code Comments
- **Complex logic** - Explain the WHY, not the WHAT
- **Security considerations** - Document security implications
- **Performance optimizations** - Note why optimization was needed
- **Workarounds** - Explain temporary solutions and link to issues

## Git Workflow

### Branch Naming
- `feature/widget-appearance-settings` - New features
- `fix/api-key-validation-bug` - Bug fixes
- `refactor/database-client-queries` - Code refactoring
- `docs/update-api-documentation` - Documentation updates

### Commit Messages
Format: `type(scope): description`

Types: `feat`, `fix`, `refactor`, `docs`, `test`, `chore`

Examples:
- `feat(widget): add customizable chat bubble colors`
- `fix(api): enforce domain restrictions on widget endpoints`
- `feat(billing): add overage tracking and email alerts`

## Performance

### Critical Metrics
- **Widget load time:** <500ms
- **Chat response time:** <3s (including LLM)
- **Dashboard load time:** <1s
- **API response time:** <200ms

### Optimization Guidelines
- **Widget:** Minimize bundle size, lazy load components
- **API:** Database query optimization, Redis caching
- **LLM:** Prompt caching (Anthropic), embedding caching
- **Database:** Index frequently queried columns (clientId, apiKey)

## Error Handling

### Error Categories
1. **Validation Errors** (400) - Bad user input
2. **Authentication Errors** (401) - Invalid/missing credentials
3. **Authorization Errors** (403) - Valid credentials, insufficient permissions
4. **Not Found Errors** (404) - Resource doesn't exist
5. **Rate Limit Errors** (429) - Too many requests
6. **Server Errors** (500) - Unexpected server issues

### Error Response Format
```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;          // Machine-readable: 'RATE_LIMIT_EXCEEDED'
    message: string;       // Human-readable: 'You have exceeded your hourly limit'
    details?: unknown;     // Optional: Additional context
  };
}
```

## Development Workflow

### Before Writing Code
1. **Read relevant docs** - Check ARCHITECTURE.md and related files
2. **Analyze existing code** - Understand patterns already in use
3. **Check for similar implementations** - DRY principle
4. **State your approach** - Explain plan before coding
5. **Rate confidence (1-10)** - If <8, ask questions first

### While Writing Code
1. **DO NOT BE LAZY. DO NOT OMIT CODE.** - Always provide complete implementations
2. **Never use `// ... existing code`** - Show all code
3. **Follow existing patterns** - Consistency is critical
4. **Add comments** - Explain complex logic
5. **Validate inputs** - Never trust user data
6. **Handle errors** - Use try-catch, return proper errors

### After Writing Code
1. **Test your changes** - Run locally and verify
2. **Update documentation** - If you changed architecture/patterns
3. **Check for security issues** - Review checklist above
4. **Consider performance** - Is this code fast enough?
5. **Summarize changes** - What did you build and why?

## Confidence Rating System

Before major changes, rate your confidence (1-10):

- **9-10:** Proceed with implementation
- **7-8:** Proceed but flag for review
- **5-6:** Ask clarifying questions first
- **1-4:** Stop and request human guidance

**If confidence <8, STOP and get human guidance.**

## Quick Reference

### File Locations
```
project/
â”œâ”€â”€ client/                 # React dashboard
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/     # React components
â”‚   â”‚   â”œâ”€â”€ pages/          # Page components
â”‚   â”‚   â”œâ”€â”€ lib/            # Utilities
â”‚   â”‚   â””â”€â”€ types/          # TypeScript types
â”œâ”€â”€ public/
â”‚   â””â”€â”€ widget/             # Widget files (vanilla JS)
â”‚       â””â”€â”€ v2/
â”‚           â””â”€â”€ widget.js
â”œâ”€â”€ server/                 # Express API
â”‚   â”œâ”€â”€ routes/             # API routes
â”‚   â”œâ”€â”€ middleware/         # Express middleware
â”‚   â””â”€â”€ services/           # External service clients
â”œâ”€â”€ ai-backend/             # Python FastAPI backend
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/            # FastAPI routes
â”‚   â”‚   â”œâ”€â”€ graph/          # LangGraph workflows
â”‚   â”‚   â”œâ”€â”€ services/       # Qdrant, LLM, Redis clients
â”‚   â”‚   â””â”€â”€ models/         # Pydantic models
â”‚   â””â”€â”€ tests/
â”œâ”€â”€ shared/                 # Shared between client/server
â”‚   â”œâ”€â”€ schema.ts           # Database schema (Drizzle)
â”‚   â””â”€â”€ types.ts            # Shared types
â”œâ”€â”€ docs/                   # Project documentation
â””â”€â”€ docker-compose.yml      # Local development stack
```

### Key Commands
```bash
# Development
npm run dev                              # Start Express + React
docker-compose up -d                     # Start all services
docker-compose -f docker-compose.yml \
  -f docker-compose.dev.yml up           # Dev mode with hot reload

# Database
npm run db:push                          # Push schema changes
npm run db:studio                        # Open Drizzle Studio

# Testing
npm test                                 # Run JS tests
cd ai-backend && pytest                  # Run Python tests

# Type checking
npm run check                            # TypeScript
cd ai-backend && mypy src                # Python
```

### Helpful Documentation
- `docs/ARCHITECTURE.md` - System design
- `docs/DEVELOPMENT.md` - Dev guidelines
- `docs/IMPLEMENTATION_AUDIT.md` - Current state
- `docs/API.md` - API reference
- `docs/BILLING_AND_LIMITS.md` - Pricing and limits
- `docs/WIDGET_API_README.md` - Widget API docs

---

**Remember:** Quality over speed. Understanding over output. Security over convenience.

**When in doubt, ASK. When confidence is low, STOP and get review.**
